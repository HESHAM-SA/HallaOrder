{% extends "home/base.html" %}
{% load static %}
{% block title %}تعديل المنتج - {{ product.name }}{% endblock title %}
{% block style %}
<link rel="stylesheet" href="{% static 'menu/css/menu.css' %}">
{% endblock style %}
{% block dashboard_content %}
<div class="row p-4">
    <h3 class="col-8">تعديل المنتج: {{ product.name }}</h3>
    <div class="col-4 d-flex gap-2 justify-content-end">
        <a href="{% url 'menu:menu_view' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-right"></i> العودة للقائمة
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" id="editProductForm" action="{% url 'menu:edit_product' product.id %}" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- Product Details Section -->
            <div class="form-grid">
                <div class="form-group">
                    <label for="product-name">اسم المنتج *</label>
                    <input type="text" name="name" id="product-name" value="{{ product.name }}" placeholder="مثال: كابتشينو مميز" required>
                </div>
                <div class="form-group">
                    <label for="product-price">السعر *</label>
                    <input type="number" name="price" id="product-price" value="{{ product.price|stringformat:'.2f' }}" step="0.01" min="0" placeholder="0.00" required>
                    <small class="form-text text-muted">السعر بالريال السعودي</small>
                </div>
                <div class="form-group">
                    <label for="product-category">الفئة *</label>
                    <select name="category" id="product-category" required>
                        <option value="">اختر الفئة</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id == product.category.id %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="product-availability">حالة التوفر</label>
                    <select name="available" id="product-availability">
                        <option value="1" {% if product.available %}selected{% endif %}>متاح</option>
                        <option value="0" {% if not product.available %}selected{% endif %}>غير متاح</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label for="product-description">وصف المنتج</label>
                    <textarea name="description" id="product-description" rows="4" placeholder="وصف تفصيلي عن المنتج...">{{ product.description|default_if_none:'' }}</textarea>
                </div>
            </div>

            <!-- Image Gallery Section -->
            <hr class="my-4">
            <h3 class="section-title">معرض الصور</h3>
            <div class="gallery-container">
                <div id="gallery-grid" class="gallery-grid">
                    {% for image in product_images %}
                    <div class="gallery-item" data-image-id="{{ image.id }}">
                        <img src="{{ image.image.url }}" alt="Product Image">
                        <div class="gallery-item-overlay">
                            <button type="button" class="gallery-action-btn delete-image-btn" title="حذف الصورة"><i class="fas fa-trash"></i></button>
                            <button type="button" class="gallery-action-btn set-cover-btn {% if image.is_cover %}d-none{% endif %}" title="تعيين كغلاف"><i class="fas fa-star"></i></button>
                        </div>
                        {% if image.is_cover %}<div class="cover-badge"><i class="fas fa-star"></i> غلاف</div>{% endif %}
                    </div>
                    {% endfor %}
                    <div class="gallery-upload-box">
                        <input type="file" name="images" id="image-upload-input" multiple accept="image/*">
                        <label for="image-upload-input" class="gallery-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i><span>إضافة صور</span>
                        </label>
                    </div>
                </div>
                <div id="image-preview-container" class="gallery-grid"></div>
            </div>

            <!-- Options & Add-ons Section -->
            <hr class="my-4">
            <h3 class="section-title">الخيارات والإضافات</h3>
            <div class="form-group full-width">
                <label>ارتباط بمجموعات الخيارات</label>
                <div class="option-group-chooser">
                    {% for group in available_option_groups %}
                    <div class="option-group-choice">
                        <input type="checkbox" name="option_groups" value="{{ group.id }}" id="group-{{ group.id }}" {% if group in product.option_groups.all %}checked{% endif %}>
                        <label for="group-{{ group.id }}">
                            <span class="group-name">{{ group.name }}</span>
                            <span class="group-type-badge">{{ group.get_selection_type_display }}</span>
                        </label>
                    </div>
                    {% empty %}
                    <p class="text-muted">لم يتم إنشاء مجموعات خيارات بعد. <br>اذهب إلى القائمة الرئيسية واضغط على "إدارة الخيارات" لإنشاء واحدة.</p>
                    {% endfor %}
                </div>
                <small class="form-text text-muted">اختر المجموعات التي يمكن للعميل تخصيصها لهذا المنتج. يمكنك إدارة المجموعات من زر "إدارة الخيارات" في صفحة القائمة الرئيسية.</small>
            </div>
            
            <div class="form-actions mt-4">
                <button type="submit" class="btn btn-orange"><i class="fas fa-save"></i> حفظ التغييرات</button>
                <a href="{% url 'menu:menu_view' %}" class="btn btn-secondary ms-2"><i class="fas fa-times"></i> إلغاء</a>
            </div>
        </form>

        <!-- DANGER ZONE - RESTORED -->
        <div class="danger-zone mt-4 pt-4" style="border-top: 2px solid #dc3545;">
            <h3 style="color: #dc3545;">منطقة الخطر</h3>
            <p class="text-muted">حذف هذا المنتج سيؤدي إلى إزالته نهائياً من القائمة.</p>
            <form method="POST" action="{% url 'menu:delete_product' product.id %}" onsubmit="return confirmDelete();">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> حذف المنتج نهائياً
                </button>
            </form>
        </div>
        <!-- END DANGER ZONE -->
    </div>
</div>

<script src="{% static 'menu/js/gallery.js' %}"></script>
<script>
// Your original validation and confirm delete functions are still here
document.getElementById('editProductForm').addEventListener('submit', function(e) {
    const name = document.getElementById('product-name').value.trim();
    const price = document.getElementById('product-price').value;
    const category = document.getElementById('product-category').value;
    if (!name || !price || !category) {
        e.preventDefault();
        alert('يرجى ملء جميع الحقول المطلوبة');
        return false;
    }
    if (parseFloat(price) < 0) {
        e.preventDefault();
        alert('يرجى إدخال سعر صحيح');
        return false;
    }
});
function confirmDelete() {
    return confirm('هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.');
}
</script>
{% endblock dashboard_content %}