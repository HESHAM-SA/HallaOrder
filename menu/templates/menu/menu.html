{% extends "home/base.html" %}
{% load static %}

{% block title %}إدارة المنتجات{% endblock title %}

{% block style %}
    <link rel="stylesheet" href="{% static 'menu/css/menu.css' %}">
{% endblock style %}


{% block dashboard_content %}

<div class="page-header mb-3">
    <h1>المنتجات</h1>
    <div class="d-flex gap-2 justify-content-end">
        <button id="manageCategoriesBtn" class="btn btn-blue"><i class="fas fa-sitemap"></i> إدارة الفئات</button>
        <button id="addProductBtn" class="btn btn-orange"><i class="fas fa-plus"></i> إضافة منتج جديد</button>
    </div>
</div>

<div class="products-container card">
    <div class="category-tabs">
        <!-- ... No changes here ... -->
    </div>
    <div class="products-content">
        {% for category in categories %}
        <section class="category-section {% if forloop.first %}active{% endif %}" id="category-{{ category.id }}">
            <div class="category-header"><h2>{{ category.name }}</h2></div>
            <table class="products-table">
               <thead><tr><th>المنتج</th><th>السعر</th><th>الحالة</th><th>إجراءات</th></tr></thead>
               <tbody>
                   {% for product in category.product_set.all %}
                   <tr>
                       <!-- ... No changes to product info, price, or toggle ... -->
                       <td>
                           <div class="action-buttons">
                               <!-- EDIT BUTTON: now a link -->
                               <a href="{% url 'menu:edit_product' product.id %}" class="action-btn edit-btn"><i class="fas fa-pen"></i></a>
                               <!-- DELETE BUTTON: now a form -->
                               <form method="POST" action="{% url 'menu:delete_product' product.id %}" onsubmit="return confirm('هل أنت متأكد من حذف هذا المنتج؟');">
                                   {% csrf_token %}
                                   <button type="submit" class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                               </form>
                           </div>
                       </td>
                   </tr>
                   {% empty %}
                   <tr><td colspan="4" class="text-center text-muted">لا توجد منتجات في هذه الفئة.</td></tr>
                   {% endfor %}
               </tbody>
            </table>
        </section>
        {% endfor %}
    </div>
</div>

<!-- Manage Categories Modal -->
<div id="manageCategoriesModal" class="modal-overlay">
    <div class="modal-content">
        <header class="modal-header"><h2>إدارة الفئات الرئيسية</h2><button class="close-btn">&times;</button></header>
        <main class="modal-body">
            <h3>الفئات الحالية</h3>
            <ul class="category-list">
                {% for category in categories %}
                <li class="d-flex justify-content-between align-items-center">
                    <span>{{ category.name }}</span>
                    <div class="action-buttons">
                        <!-- EDIT BUTTON: now a link -->
                        <a href="{% url 'menu:edit_category' category.id %}" class="action-btn edit-btn"><i class="fas fa-pen"></i></a>
                        <!-- DELETE BUTTON: now a form -->
                        <form method="POST" action="{% url 'menu:delete_category' category.id %}" onsubmit="return confirm('هل أنت متأكد من حذف هذه الفئة؟ سيتم حذف جميع المنتجات بداخلها.');">
                            {% csrf_token %}
                            <button type="submit" class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                        </form>
                    </div>
                </li>
                {% empty %}<li>لا توجد فئات لعرضها.</li>{% endfor %}
            </ul>
            <!-- ADD CATEGORY FORM: Updated with method and action -->
            <form method="POST" action="{% url 'menu:menu' %}" style="margin-top: 30px;">
                {% csrf_token %}
                <h3>إضافة فئة جديدة</h3>
                <div class="form-group"><label for="new-cat-name">اسم الفئة</label><input type="text" name="name" id="new-cat-name" placeholder="مثال: المشروبات" required></div>
                <div class="modal-footer"><button type="submit" name="add_category" class="btn btn-orange">حفظ الفئة</button></div>
            </form>
        </main>
    </div>
</div>

<!-- Add Product Modal: Updated with method and action -->
<div id="productModal" class="modal-overlay">
    <div class="modal-content">
        <header class="modal-header"><h2>إضافة منتج جديد</h2><button class="close-btn">&times;</button></header>
        <main class="modal-body">
            <form method="POST" action="{% url 'menu:menu' %}">
                {% csrf_token %}
                <div class="form-grid">
                    <!-- ... No changes to form fields ... -->
                </div>
                <div class="modal-footer"><button type="submit" name="add_product" class="btn btn-orange">حفظ المنتج</button></div>
            </form>
        </main>
    </div>
</div>

<script src="{% static 'menu/js/menu.js' %}"></script>
{% endblock dashboard_content %}