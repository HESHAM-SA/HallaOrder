{% extends "home/base.html" %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<style>
    #map {
        width: 100%;
        height: 300px;
        border-radius: 1rem;
        margin-top: .5rem;
    }

    .logo-preview {
        width: 100%;
        max-width: 200px;
        aspect-ratio: 1/1;
        object-fit: contain;
        border: 1px dashed #ccc;
        border-radius: 1rem;
        padding: .5rem;
        background: #fff
    }
</style>
{% endblock style %}

{% block content %}
<style>
    #dashbaord {
        display: none;
    }
</style>

{% include "home/header_platform.html" %}

<div class="w-100">
    {% if messages %}
    <ul>
        {% for message in messages %}
        <div class="alert {{message.tags}}">
            <i class="fa-solid fa-circle-exclamation"></i>
            <span>{{message}}</span>
        </div>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<div class="row w-100 p-4">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <h1 class="p-3">إضافة فرع جديد</h1>
            <div class="card-body">
                <form action="" method="post" class="row g-3">
                    {% csrf_token %}

                    <!-- اسم الفرع -->
                    <div class="col-md-6">
                        <label for="branch_name" class="form-label">اسم الفرع</label>
                        <input type="text" class="form-control" id="branch_name" name="name" required maxlength="200"
                            placeholder="مثال: فرع حي السلامة">
                    </div>

                    <!-- عنوان الفرع -->
                    <div class="col-md-6">
                        <label for="branch_address" class="form-label">عنوان الفرع</label>
                        <input type="text" class="form-control" id="branch_address" name="address"
                            placeholder="ابحث عن الموقع أو أدخل العنوان يدوياً" required>
                    </div>

                    <div class="col-12">
                        <div id="map"></div>
                        <small class="text-muted">يمكنك البحث أو تحديد الموقع من الخريطة.</small>
                    </div>
                    <hr class="mt-4" />

                    <div class="col-12 d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-blue">حفظ</button>
                        <button type="reset" class="btn btn-orange">تفريغ الحقول</button>
                        <a href="{% url 'home:create_restaurant_identity' %}" class="btn btn-dark">رجوع</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{google_map_key}}&libraries=places"></script>
<script>
    let map, marker, autocomplete;

    function initMap() {
        const defaultLocation = { lat: 21.543333, lng: 39.172778 }; // جدة كموقع افتراضي
        map = new google.maps.Map(document.getElementById("map"), {
            center: defaultLocation,
            zoom: 12,
        });

        marker = new google.maps.Marker({
            map,
            position: defaultLocation,
            draggable: true,
        });

        // تحديث العنوان عند سحب المؤشر
        google.maps.event.addListener(marker, 'dragend', function () {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: marker.getPosition() }, function (results, status) {
                if (status === 'OK' && results[0]) {
                    document.getElementById("branch_address").value = results[0].formatted_address;
                }
            });
        });

        // Autocomplete للعنوان
        const input = document.getElementById("branch_address");
        autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) return;

            map.setCenter(place.geometry.location);
            map.setZoom(16);

            marker.setPosition(place.geometry.location);
        });
    }

    window.onload = initMap;
</script>

{% endblock content %}
